<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد المقالات الذكي المتكامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f4f7f9;
        }
        .container {
            max-width: 900px;
        }
        /* تنسيقات الشريط الجانبي الرئيسي (الأدوات) - يظهر من اليمين لليسار */
        .main-sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 60; /* أعلى من شريط الإعدادات */
            transform: translateX(100%); /* مخفي على اليمين */
        }
        .main-sidebar.active {
            transform: translateX(0);
        }
        /* تنسيقات شريط الإعدادات */
        .settings-sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50; 
            transform: translateX(100%); /* مخفي على اليمين */
        }
        .settings-sidebar.active {
            transform: translateX(0);
        }

        .shadow-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .keyword-tag {
            background-color: #f0f4ff;
            color: #4338ca;
        }

        /* تنسيقات شاشة الدخول */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #e2e8f0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    
    <div id="login-screen" class="w-full">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">تسجيل الدخول</h2>
            
            <div id="login-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-sm" role="alert">
                <span class="block sm:inline">اسم المستخدم أو كلمة المرور غير صحيحة.</span>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="login-username" class="block text-gray-700 font-medium mb-1">اسم المستخدم:</label>
                    <input type="text" id="login-username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="admin">
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 font-medium mb-1">كلمة المرور:</label>
                    <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="كلمة المرور">
                </div>
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md">
                    دخول
                </button>
            </div>
            <p class="text-center text-xs text-gray-500 mt-6">هذه بوابة وصول بسيطة (Client-Side).</p>
        </div>
    </div>


    <div id="app-content" class="min-h-screen flex flex-col" style="display: none;">
        
        <button id="openMainSidebarBtn" class="fixed top-4 right-4 bg-indigo-600 text-white p-3 rounded-full shadow-lg z-[100] hover:bg-indigo-700 transition duration-300 transform hover:scale-110">
            <i class="fas fa-bars"></i>
        </button>

        <div id="mainSidebar" class="main-sidebar fixed top-0 right-0 h-full w-64 bg-white shadow-2xl p-4 overflow-y-auto">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-tools text-indigo-500 ml-2"></i>
                    الأدوات الرئيسية
                </h2>
                <button id="closeMainSidebarBtn" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <nav class="space-y-3">
                <a href="#" class="block p-2 text-gray-700 hover:bg-indigo-50 rounded-lg transition duration-150 font-medium">
                    <i class="fas fa-magic w-6 ml-2 text-indigo-500"></i>
                    إنشاء مقال جديد
                </a>
                <a href="#keywords-tool-section" class="block p-2 text-gray-700 hover:bg-indigo-50 rounded-lg transition duration-150 font-medium">
                    <i class="fas fa-key w-6 ml-2 text-yellow-500"></i>
                    أداة الكلمات المفتاحية
                </a>
                <a href="#paraphrase-tool-section" class="block p-2 text-gray-700 hover:bg-indigo-50 rounded-lg transition duration-150 font-medium">
                    <i class="fas fa-copy w-6 ml-2 text-red-500"></i>
                    صياغة مقال من رابط
                </a>
                <button id="openSettingsBtn" class="w-full text-right p-2 text-gray-700 hover:bg-indigo-50 rounded-lg transition duration-150 font-medium">
                    <i class="fas fa-cogs w-6 ml-2 text-green-500"></i>
                    إدارة الإعدادات (API/WP)
                </button>
                <button id="logout-btn" class="w-full text-right p-2 text-gray-700 hover:bg-red-50 rounded-lg transition duration-150 font-medium">
                    <i class="fas fa-sign-out-alt w-6 ml-2 text-red-500"></i>
                    تسجيل الخروج
                </button>
            </nav>
        </div>

        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity hidden"></div>
        
        <div id="settingsSidebar" class="settings-sidebar fixed top-0 right-0 h-full w-full sm:w-80 bg-white shadow-2xl p-6 sm:p-8 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-cogs text-indigo-500 ml-2"></i>
                    إعدادات API & WP
                </h2>
                <button id="closeSettingsSidebar" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-6">
                
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <h3 class="font-bold text-indigo-700 mb-3">المُنشئ Gemini API</h3>
                    <label for="geminiApiKey" class="block text-gray-700 text-sm font-medium mb-1">مفتاح API Gemini Key</label>
                    <input type="password" id="geminiApiKey" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="ادخل مفتاحك هنا">
                </div>

                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h3 class="font-bold text-green-700 mb-3">إعدادات ترحيل ووردبريس</h3>
                    <label for="wpUrl" class="block text-gray-700 text-sm font-medium mb-1">رابط الموقع (مثلاً: https://yourdomain.com)</label>
                    <input type="url" id="wpUrl" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="https://yourdomain.com">
                    
                    <label for="wpUsername" class="block text-gray-700 text-sm font-medium mt-3 mb-1">اسم المستخدم</label>
                    <input type="text" id="wpUsername" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="عادةً اسم مستخدم المشرف">

                    <label for="wpAppPassword" class="block text-gray-700 text-sm font-medium mt-3 mb-1">كلمة مرور التطبيق (Application Password)</label>
                    <input type="password" id="wpAppPassword" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="كلمة المرور التي تم إنشاؤها">
                    <p class="text-xs text-gray-500 mt-1">يجب استخدام كلمة مرور التطبيق وليس كلمة مرور تسجيل الدخول العادية.</p>
                </div>
                
                <button id="saveSettings" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md">
                    حفظ الإعدادات
                </button>
            </div>
        </div>

        <div id="app" class="container mx-auto p-4 md:p-8 flex-grow">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">مولد المقالات الذكي المتكامل</h1>
                <p class="text-lg text-gray-600 mt-2">محرر متقدم لتوليد ونشر المحتوى.</p>
            </header>

            <div id="status-area" class="p-4 bg-yellow-100 border-r-4 border-yellow-500 text-yellow-700 rounded-lg shadow-md mb-6 hidden" role="alert">
                <p class="font-bold" id="status-title">تنبيه</p>
                <p id="error-message">الرجاء إدخال مفتاح API الخاص بك في الإعدادات.</p>
            </div>

            <section id="content-editor" class="bg-white p-6 rounded-xl shadow-custom transition duration-300">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">مسودة المقال</h2>
                
                <div class="mb-4">
                    <label for="postTitle" class="block text-gray-700 font-medium mb-1">عنوان المقال (مطلوب للنشر):</label>
                    <input type="text" id="postTitle" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition duration-150" placeholder="أدخل عنوانًا جذابًا للمقال">
                </div>

                <div class="mb-4">
                    <label for="customPrompt" class="block text-gray-700 font-medium mb-1 flex justify-between items-center">
                        تعليمات إضافية للذكاء الاصطناعي (اختياري):
                        <span class="text-xs text-gray-500">لتوجيه أسلوب الكتابة</span>
                    </label>
                    <textarea id="customPrompt" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150" placeholder="مثال: اكتب بنبرة مرحة ومحفزة، وركز على الفوائد الاقتصادية."></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="newsContent" class="block text-gray-700 font-medium mb-1">المحتوى/الملخص:</label>
                    <textarea id="newsContent" rows="10" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition duration-150" placeholder="اكتب هنا فكرة أو ملخصًا صغيرًا، أو الصق مقالًا لتعديله."></textarea>
                </div>
                
                <div class="flex flex-col md:flex-row justify-center gap-4">
                    <button id="generateButton" class="w-full md:w-auto bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-700 transition duration-300 shadow-xl flex items-center justify-center transform hover:scale-105">
                        <i class="fas fa-magic ml-2"></i>
                        توليد المقال (محتوى وملخص)
                    </button>
                    
                    <button id="wordpressPostButton" class="w-full md:w-auto bg-green-600 text-white font-bold py-3 px-8 rounded-full hover:bg-green-700 transition duration-300 shadow-xl flex items-center justify-center transform hover:scale-105">
                        <i class="fab fa-wordpress ml-2"></i>
                        ترحيل المسودة إلى ووردبريس
                    </button>
                </div>
            </section>
            
            <section id="keywords-tool-section" class="bg-white p-6 rounded-xl shadow-custom mt-8 transition duration-300">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center">
                    <i class="fas fa-key text-yellow-500 ml-2"></i>
                    أداة الكلمات المفتاحية (للتوليد السريع)
                </h2>

                <div class="flex mb-4 gap-2">
                    <input type="text" id="newKeywordInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" placeholder="أدخل كلمة مفتاحية واضغط إضافة">
                    <button id="addKeywordBtn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 transition duration-150">
                        إضافة
                    </button>
                </div>

                <ul id="keywordsList" class="space-y-3">
                    </ul>
            </section>

            <section id="paraphrase-tool-section" class="bg-white p-6 rounded-xl shadow-custom mt-8 transition duration-300">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2 flex items-center">
                    <i class="fas fa-copy text-red-500 ml-2"></i>
                    جلب وإعادة صياغة مقال من رابط
                </h2>

                <div class="p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg mb-4 text-sm">
                    **تم الربط!** هذه الميزة تعمل الآن عبر الواجهة الخلفية (Backend Proxy) على Vercel.
                </div>

                <div class="flex mb-4 gap-2">
                    <input type="url" id="articleLinkInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="الصق رابط المقال الذي تريد صياغته (URL)">
                    <button id="fetchAndRewriteBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150">
                        جلب وصياغة
                    </button>
                </div>
                
                <div id="paraphraseStatus" class="text-sm text-gray-600"></div>
            </section>

        </div>
        
        <footer class="mt-8 py-4 text-center text-sm text-gray-500 bg-white border-t">
            <p>&copy; 2024. جميع الحقوق محفوظة لـ **أحمد خالد**.</p>
        </footer>
    </div>


    <script type="module">
        
        // ====================================================================
        //  الإعدادات الثابتة
        // ====================================================================
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;

        // **هام:** تم تحديث هذا إلى نقطة نهاية الـ Backend Proxy الخاصة بك على Vercel
        const PROXY_API_URL = 'https://newss-rosy.vercel.app/api/rewrite'; 
        
        // **الإعدادات الأمنية لتسجيل الدخول (يجب تغييرها)**
        const REQUIRED_USERNAME = 'admin';
        const REQUIRED_PASSWORD = '12345';
        const ACCESS_TOKEN_KEY = 'AppAccessGranted';


        // ====================================================================
        //  تعريف عناصر DOM الجديدة والمعدلة
        // ====================================================================
        
        // عناصر شاشة الدخول
        const loginScreen = document.getElementById('login-screen');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginButton = document.getElementById('login-btn');
        const loginErrorMessage = document.getElementById('login-error-message');
        const appContent = document.getElementById('app-content'); // محتوى التطبيق الرئيسي
        const logoutButton = document.getElementById('logout-btn'); // زر الخروج الجديد

        // عناصر القائمة الرئيسية والأزرار
        const openMainSidebarBtn = document.getElementById('openMainSidebarBtn');
        const mainSidebar = document.getElementById('mainSidebar');
        const closeMainSidebarBtn = document.getElementById('closeMainSidebarBtn');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const openSettingsBtn = document.getElementById('openSettingsBtn'); // الزر داخل القائمة الرئيسية

        // عناصر شريط الإعدادات
        const settingsSidebar = document.getElementById('settingsSidebar'); 
        const closeSettingsSidebar = document.getElementById('closeSettingsSidebar');
        const saveSettings = document.getElementById('saveSettings');
        const geminiApiKeyInput = document.getElementById('geminiApiKey');
        const wpUrlInput = document.getElementById('wpUrl');
        const wpUsernameInput = document.getElementById('wpUsername');
        const wpAppPasswordInput = document.getElementById('wpAppPassword');

        // عناصر محرر المقال
        const postTitleInput = document.getElementById('postTitle');
        const customPromptInput = document.getElementById('customPrompt');
        const newsContentInput = document.getElementById('newsContent');
        const generateButton = document.getElementById('generateButton');
        const wordpressPostButton = document.getElementById('wordpressPostButton');
        const statusArea = document.getElementById('status-area');
        const statusTitle = document.getElementById('status-title');
        const errorMessage = document.getElementById('error-message');

        // عناصر أداة الكلمات المفتاحية
        const newKeywordInput = document.getElementById('newKeywordInput');
        const addKeywordBtn = document.getElementById('addKeywordBtn');
        const keywordsList = document.getElementById('keywordsList');

        // عناصر أداة الصياغة
        const articleLinkInput = document.getElementById('articleLinkInput');
        const fetchAndRewriteBtn = document.getElementById('fetchAndRewriteBtn');
        const paraphraseStatus = document.getElementById('paraphraseStatus');


        // ====================================================================
        //  حالة التطبيق (State) - يتم تحميلها من localStorage
        // ====================================================================
        
        function loadSettings() {
            return {
                geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                wpUrl: localStorage.getItem('wpUrl') || '',
                wpUsername: localStorage.getItem('wpUsername') || '',
                wpAppPassword: localStorage.getItem('wpAppPassword') || '',
                keywords: JSON.parse(localStorage.getItem('keywordsList')) || []
            };
        }

        let settings = loadSettings();
        
        // تعبئة حقول الإدخال بالبيانات المحفوظة
        geminiApiKeyInput.value = settings.geminiApiKey;
        wpUrlInput.value = settings.wpUrl;
        wpUsernameInput.value = settings.wpUsername;
        wpAppPasswordInput.value = settings.wpAppPassword;

        // ====================================================================
        //  وظائف واجهة المستخدم (UI Functions)
        // ====================================================================
        
        function showStatus(title, message, type = 'warning') {
            statusTitle.textContent = title;
            errorMessage.innerHTML = message;
            
            // إعادة تعيين الألوان
            statusArea.className = 'p-4 rounded-lg shadow-md mb-6';
            
            if (type === 'success') {
                statusArea.classList.add('bg-green-100', 'border-r-4', 'border-green-500', 'text-green-700');
            } else if (type === 'error') {
                statusArea.classList.add('bg-red-100', 'border-r-4', 'border-red-500', 'text-red-700');
            } else { // warning/info
                statusArea.classList.add('bg-yellow-100', 'border-r-4', 'border-yellow-500', 'text-yellow-700');
            }
            statusArea.classList.remove('hidden');
        }

        function hideStatus() {
            statusArea.classList.add('hidden');
        }

        // ====================================================================
        //  معالجة تسجيل الدخول (جديد)
        // ====================================================================
        
        function checkAccess() {
            // التحقق من وجود رمز مرور في localStorage (للتذكر بين الجلسات)
            const token = localStorage.getItem(ACCESS_TOKEN_KEY);
            if (token === 'granted') {
                showApp();
            } else {
                showLogin();
            }
        }

        function showApp() {
            loginScreen.style.display = 'none';
            appContent.style.display = 'flex';
        }

        function showLogin() {
            loginScreen.style.display = 'flex';
            appContent.style.display = 'none';
        }

        function attemptLogin() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (username === REQUIRED_USERNAME && password === REQUIRED_PASSWORD) {
                localStorage.setItem(ACCESS_TOKEN_KEY, 'granted'); // حفظ الرمز
                showApp();
            } else {
                loginErrorMessage.classList.remove('hidden');
                loginPasswordInput.value = ''; // مسح كلمة المرور
            }
        }
        
        // ربط زر الدخول
        loginButton.addEventListener('click', attemptLogin);

        // تمكين الدخول بزر Enter
        loginPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                attemptLogin();
            }
        });
        
        // ربط زر الخروج
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem(ACCESS_TOKEN_KEY);
            showLogin();
            closeSidebars(); // إغلاق أي أشرطة جانبية مفتوحة
        });

        // ====================================================================
        //  معالجة إعدادات الأشرطة الجانبية
        // ====================================================================
        
        openMainSidebarBtn.addEventListener('click', () => {
            mainSidebar.classList.add('active');
            sidebarOverlay.classList.remove('hidden');
        });

        const closeSidebars = () => {
            mainSidebar.classList.remove('active');
            settingsSidebar.classList.remove('active');
            sidebarOverlay.classList.add('hidden');
        };

        closeMainSidebarBtn.addEventListener('click', closeSidebars);
        sidebarOverlay.addEventListener('click', closeSidebars);
        
        openSettingsBtn.addEventListener('click', () => {
            settingsSidebar.classList.add('active');
        });

        closeSettingsSidebar.addEventListener('click', () => {
            settingsSidebar.classList.remove('active');
        });


        // 3. حفظ الإعدادات
        saveSettings.addEventListener('click', () => {
            settings.geminiApiKey = geminiApiKeyInput.value.trim();
            settings.wpUrl = wpUrlInput.value.trim();
            settings.wpUsername = wpUsernameInput.value.trim();
            settings.wpAppPassword = wpAppPasswordInput.value.trim();

            localStorage.setItem('geminiApiKey', settings.geminiApiKey);
            localStorage.setItem('wpUrl', settings.wpUrl);
            localStorage.setItem('wpUsername', settings.wpUsername);
            localStorage.setItem('wpAppPassword', settings.wpAppPassword);
            
            showStatus('تم الحفظ', 'تم حفظ إعدادات Gemini و ووردبريس بنجاح.', 'success');
            settingsSidebar.classList.remove('active');
            closeSidebars();
        });


        // ====================================================================
        //  وظيفة توليد المحتوى بالذكاء الاصطناعي (Gemini)
        // ====================================================================
        
        generateButton.addEventListener('click', async () => {
            if (!settings.geminiApiKey) {
                showStatus('خطأ في الإعدادات', 'الرجاء إدخال مفتاح Gemini API في الشريط الجانبي وحفظه.', 'error');
                return;
            }
            
            const userPrompt = newsContentInput.value.trim();
            const customInstruction = customPromptInput.value.trim();

            if (!userPrompt) {
                showStatus('تنبيه', 'الرجاء كتابة مسودة أو ملخص في مربع المحتوى لتوليد مقال كامل.', 'warning');
                return;
            }
            
            // إظهار حالة التحميل
            const originalButtonText = generateButton.innerHTML;
            generateButton.innerHTML = `<svg class="animate-spin h-5 w-5 ml-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        جاري التوليد...`;
            generateButton.disabled = true;
            hideStatus(); 

            const geminiApiUrl = API_BASE_URL + settings.geminiApiKey;
            
            let systemPrompt = `
                أنت كاتب مقالات عربي محترف وموضوعي.
                مهمتك هي أخذ الفكرة أو الملخص الذي قدمه المستخدم وتوسيعه ليصبح مقالًا كاملاً ومفصلاً ومناسبًا للنشر.
                يجب أن يكون المقال:
                1. مكتوبًا باللغة العربية الفصحى.
                2. يحتوي على مقدمة جذابة، ومتن مقسم إلى فقرات، وخاتمة تلخص الموضوع.
                3. لا تستخدم العناوين الفرعية أو الرموز (مثل # أو * أو -).
                4. لا تضيف معلومات غير موجودة في فكرة المستخدم ما لم تكن لربط الأفكار منطقياً.
                5. يجب أن يتراوح طوله بين 250 و 350 كلمة.
            `;
            
            // إضافة التعليمات المخصصة للبرومبت
            if (customInstruction) {
                systemPrompt += `\n\nتعليمات المستخدم الخاصة للأسلوب والنبرة: ${customInstruction}`;
            }

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                let response;
                let text = '';
                let retryCount = 0;
                const MAX_RETRIES = 3; 

                while (retryCount < MAX_RETRIES) {
                    try {
                        response = await fetch(geminiApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'لم يتمكن الذكاء الاصطناعي من توليد محتوى.';
                            break; 
                        } else {
                            if (response.status === 429 || response.status >= 500) {
                                throw new Error(`HTTP error with status ${response.status}. Retrying...`);
                            } else {
                                const errorData = await response.json();
                                throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                            }
                        }
                    } catch (error) {
                        retryCount++;
                        if (retryCount >= MAX_RETRIES) {
                            throw error; 
                        }
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                // تحديث المحتوى
                newsContentInput.value = text;
                
                // تحديث حالة الزر
                generateButton.innerHTML = 'تم التوليد بنجاح!';
                generateButton.classList.replace('bg-indigo-600', 'bg-green-600');
                setTimeout(() => {
                    generateButton.innerHTML = originalButtonText;
                    generateButton.classList.replace('bg-green-600', 'bg-indigo-600');
                    generateButton.disabled = false;
                }, 2500);

            } catch (e) {
                console.error("Error generating content: ", e);
                showStatus('خطأ في التوليد', 'فشل التوليد: ' + e.message + '. (قد يكون مفتاح API غير صحيح أو انتهى الحد الأقصى).', 'error');
                generateButton.innerHTML = originalButtonText;
                generateButton.disabled = false;
            }
        });


        // ====================================================================
        //  وظائف أداة الكلمات المفتاحية
        // ====================================================================

        // وظيفة عرض الكلمات المفتاحية
        function renderKeywords() {
            keywordsList.innerHTML = ''; // تفريغ القائمة
            settings.keywords.forEach((keyword, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-200';
                listItem.innerHTML = `
                    <span class="text-gray-700 font-medium keyword-tag p-1 rounded">${keyword}</span>
                    <div class="flex gap-2">
                        <button data-keyword="${keyword}" class="generate-quick-btn bg-indigo-500 text-white text-sm py-1 px-3 rounded-md hover:bg-indigo-600 transition duration-150 transform hover:scale-105">
                            <i class="fas fa-arrow-left ml-1"></i> توليد مقال
                        </button>
                        <button data-index="${index}" class="remove-keyword-btn text-red-500 hover:text-red-700 transition duration-150">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                keywordsList.appendChild(listItem);
            });
            localStorage.setItem('keywordsList', JSON.stringify(settings.keywords));
        }

        // إضافة كلمة مفتاحية
        addKeywordBtn.addEventListener('click', () => {
            const keyword = newKeywordInput.value.trim();
            if (keyword && !settings.keywords.includes(keyword)) {
                settings.keywords.push(keyword);
                newKeywordInput.value = '';
                renderKeywords();
            }
        });

        // معالجة النقر على أزرار التوليد والحذف
        keywordsList.addEventListener('click', (event) => {
            // زر توليد مقال سريع
            if (event.target.classList.contains('generate-quick-btn')) {
                const keyword = event.target.getAttribute('data-keyword');
                postTitleInput.value = keyword; // نسخ الكلمة للعنوان
                newsContentInput.value = `أريد مقالاً مفصلاً عن الكلمة المفتاحية: ${keyword}`; // وضع برومبت أساسي في المحتوى
                showStatus('جاهز للتوليد', `تم نسخ الكلمة المفتاحية **"${keyword}"** لحقل العنوان والمحتوى. اضغط على **"توليد المقال"** في الأعلى.`, 'info');
                document.getElementById('content-editor').scrollIntoView({ behavior: 'smooth' });
            }
            
            // زر الحذف
            if (event.target.classList.contains('remove-keyword-btn') || event.target.closest('.remove-keyword-btn')) {
                const button = event.target.closest('.remove-keyword-btn');
                const index = button.getAttribute('data-index');
                settings.keywords.splice(index, 1);
                renderKeywords();
            }
        });

        // عرض الكلمات المفتاحية عند التحميل
        renderKeywords();


        // ====================================================================
        //  وظيفة أداة جلب المقالات وإعادة الصياغة (Backend Proxy)
        // ====================================================================

        fetchAndRewriteBtn.addEventListener('click', async () => {
            const articleUrl = articleLinkInput.value.trim();
            if (!articleUrl) {
                paraphraseStatus.innerHTML = '<span class="text-red-600">الرجاء إدخال رابط مقال صالح.</span>';
                return;
            }

            if (!settings.geminiApiKey) {
                paraphraseStatus.innerHTML = '<span class="text-red-600 font-bold">عذراً!</span> يرجى إدخال مفتاح Gemini API في شريط الإعدادات أولاً.';
                return;
            }
            
            paraphraseStatus.innerHTML = `<span class="text-indigo-600 flex items-center">
                <svg class="animate-spin h-4 w-4 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                جاري جلب المحتوى وإعادة صياغته عبر خادم Vercel...
            </span>`;
            
            try {
                // الاتصال بـ Backend Proxy على Vercel
                const backendResponse = await fetch(PROXY_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: articleUrl, apiKey: settings.geminiApiKey })
                });
                
                const data = await backendResponse.json();

                if (backendResponse.ok) {
                    
                    // افتراض أن الـ Backend يعيد النص المُعاد صياغته في حقل rewrittenText
                    newsContentInput.value = data.rewrittenText || 'فشل في الحصول على النص المُعاد صياغته من الخادم.';
                    paraphraseStatus.innerHTML = '<span class="text-green-600 font-bold">تمت إعادة الصياغة بنجاح!</span> تم وضع المحتوى الجديد في مربع "المحتوى/الملخص".';
                    document.getElementById('content-editor').scrollIntoView({ behavior: 'smooth' });
                } else {
                    // عرض رسالة الخطأ القادمة من الواجهة الخلفية (Backend)
                    throw new Error(data.error || "خطأ غير معروف في الاتصال بالواجهة الخلفية (Backend).");
                }
                
            } catch(e) {
                 paraphraseStatus.innerHTML = `<span class="text-red-600">فشل العملية: ${e.message}</span>`;
            }

        });
        
        // ====================================================================
        //  وظيفة النشر إلى ووردبريس (WordPress Post)
        // ====================================================================
        
        wordpressPostButton.addEventListener('click', async () => {
            // 1. التحقق من إعدادات ووردبريس
            if (!settings.wpUrl || !settings.wpUsername || !settings.wpAppPassword) {
                showStatus('خطأ في إعدادات ووردبريس', 'الرجاء إدخال رابط الموقع واسم المستخدم وكلمة مرور التطبيق وحفظها في الشريط الجانبي.', 'error');
                return;
            }
            
            // 2. التحقق من المحتوى
            const title = postTitleInput.value.trim();
            const content = newsContentInput.value.trim();
            
            if (!title || !content) {
                showStatus('تنبيه', 'الرجاء التأكد من كتابة **عنوان المقال** و **محتوى المقال**.', 'warning');
                return;
            }

            // 3. إعداد بيانات النشر
            const cleanUrl = settings.wpUrl.replace(/\/$/, ""); 
            const targetUrl = `${cleanUrl}/wp-json/wp/v2/posts`;
            const authHeader = 'Basic ' + btoa(settings.wpUsername + ':' + settings.wpAppPassword);
            
            const postData = {
                title: title,
                content: content,
                status: 'draft' 
            };
            
            // إظهار حالة التحميل
            const originalButtonText = wordpressPostButton.innerHTML;
            wordpressPostButton.innerHTML = `<svg class="animate-spin h-5 w-5 ml-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            جاري الترحيل...`;
            wordpressPostButton.disabled = true;
            hideStatus(); 

            try {
                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify(postData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const postLink = result.link;
                    
                    showStatus('تم بنجاح!', `تم ترحيل المقال كـ **مسودة** إلى ووردبريس. <a href="${postLink}" target="_blank" class="text-blue-700 underline font-bold hover:text-blue-500">مشاهدة المسودة</a>`, 'success');
                    
                    wordpressPostButton.innerHTML = 'تم الترحيل!';
                    wordpressPostButton.classList.replace('bg-green-600', 'bg-blue-600');
                    
                } else {
                    const errorData = await response.json();
                    let msg = errorData.message || `خطأ HTTP: ${response.status}`;

                    if (response.status === 401) {
                         msg = 'فشل المصادقة: تأكد من أن **اسم المستخدم** و **كلمة مرور التطبيق** صحيحان، ومن تفعيل إذن النشر.';
                    } else if (response.status === 404) {
                         msg = 'خطأ 404: تأكد من أن رابط الموقع صحيح وأن الـ API متاح (wp-json/wp/v2/posts).';
                    }
                    
                    showStatus('فشل الترحيل!', msg, 'error');
                }

            } catch (e) {
                console.error("Error posting to WordPress: ", e);
                showStatus('فشل الترحيل!', 'حدث خطأ في الاتصال: تأكد من تشغيل الموقع وعدم وجود قيود CORS. ' + e.message, 'error');
            } finally {
                wordpressPostButton.innerHTML = originalButtonText;
                wordpressPostButton.classList.replace('bg-blue-600', 'bg-green-600');
                wordpressPostButton.disabled = false;
            }
        });
        
        // ====================================================================
        //  وظيفة التشغيل عند تحميل الصفحة
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // أولاً: التحقق من تسجيل الدخول
            checkAccess(); 
            
            // ثانياً: عرض تنبيه API إذا كان التطبيق مفتوحاً والمفتاح غير موجود
            if (appContent.style.display !== 'none' && !settings.geminiApiKey) {
                showStatus('تنبيه هام', 'الرجاء إدخال مفتاح Gemini API وحفظه في قسم **الإعدادات** لبدء استخدام المولد.', 'warning');
            }
        });

    </script>
</body>
                        </html>
